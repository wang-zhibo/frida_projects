# Frida 反检测工具 - 快速开始指南

## 🚀 5分钟上手

### 步骤 1: 准备工作

```bash
# 安装依赖
pip install lief

# 给脚本添加执行权限
chmod +x anti-anti-frida_v2.py
chmod +x frida_analyzer.py
```

### 步骤 2: 分析原始文件

```bash
# 先分析一下 frida-server 有哪些特征
python frida_analyzer.py frida-server
```

**输出示例**：
```
============================================================
Frida 特征分析工具
============================================================

分析文件: frida-server

[*] 分析符号表...
[!] 发现 158 个敏感符号
    frida_agent_main
    frida_agent_init
    ...

[*] 分析字符串特征...
[!] 发现 47 个敏感字符串
    FridaScriptEngine
    gum-js-loop
    ...

============================================================
分析摘要
============================================================
符号表敏感项:   158
字符串敏感项:   47
线程名敏感项:   3
总计:          208

[!] 建议: 该文件包含 Frida 特征，容易被检测
[*] 请使用 anti-anti-frida 工具进行修补
```

### 步骤 3: 修补文件

#### 方案 A: 标准模式（推荐新手）

```bash
# 先预览会做哪些修改
python anti-anti-frida_v2.py frida-server --dry-run -v

# 确认无误后执行修补
python anti-anti-frida_v2.py frida-server -o frida-server-patched
```

#### 方案 B: 激进模式（对抗强度检测）

```bash
# 激进模式修补更多特征
python anti-anti-frida_v2.py frida-server -o frida-server-patched --aggressive -v
```

### 步骤 4: 验证修补效果

```bash
# 对比修补前后的差异
python frida_analyzer.py frida-server frida-server-patched
```

**输出示例**：
```
============================================================
改进效果
============================================================
修补前特征数: 208
修补后特征数: 12
清除特征数:   196
清除比例:     94.2%
[✓] 修补有效
```

### 步骤 5: 部署到设备

```bash
# 推送到 Android 设备
adb push frida-server-patched /data/local/tmp/

# 重命名为普通名称（避免进程名检测）
adb shell "mv /data/local/tmp/frida-server-patched /data/local/tmp/daemon_service"

# 添加执行权限
adb shell "chmod 755 /data/local/tmp/daemon_service"

# 修改端口启动（避免 27042 端口检测）
adb shell "/data/local/tmp/daemon_service -l 0.0.0.0:8888 &"
```

### 步骤 6: 连接测试

```bash
# 在 PC 上连接（使用自定义端口）
frida-ps -H 127.0.0.1:8888

# 或者先转发端口
adb forward tcp:8888 tcp:8888
frida-ps -H 127.0.0.1:8888

# Hook 测试
frida -H 127.0.0.1:8888 -f com.example.app -l script.js
```

## 📊 三个版本对比

### 原版 (anti-anti-frida.py)
```bash
python anti-anti-frida.py frida-server
```
- ✅ 基础功能
- ❌ 无参数验证
- ❌ 无备份
- ❌ 特征覆盖少（4个）

### v1 优化版 (anti-anti-frida_v1.py)
```bash
python anti-anti-frida_v1.py frida-server -o output.so
```
- ✅ 完善的参数和错误处理
- ✅ 自动备份
- ✅ 配置文件支持
- ✅ 干运行模式
- ⚠️ 特征覆盖一般（7个）

### v2 深度优化版 (anti-anti-frida_v2.py) ⭐ **推荐**
```bash
python anti-anti-frida_v2.py frida-server -o output.so --aggressive
```
- ✅ 所有 v1 功能
- ✅ **特征覆盖全面（35+个）**
- ✅ **Gum 引擎特征清除**
- ✅ 激进模式
- ✅ 多种替换策略
- ✅ 使用建议

## 🎯 常见场景

### 场景 1: 轻度检测的 App

**检测手段**: 只检测 "frida" 字符串

**方案**:
```bash
python anti-anti-frida.py frida-server  # 原版即可
```

### 场景 2: 中度检测的 App

**检测手段**: 字符串 + 符号表 + 线程名

**方案**:
```bash
python anti-anti-frida_v2.py frida-server -o patched  # v2 标准模式
adb push patched /data/local/tmp/system_daemon
adb shell "/data/local/tmp/system_daemon -l 0.0.0.0:8888 &"
```

### 场景 3: 重度检测的 App

**检测手段**: 全面扫描 + Gum 特征 + 端口 + 进程名

**方案**:
```bash
# 1. 使用激进模式修补
python anti-anti-frida_v2.py frida-server -o patched --aggressive

# 2. 重命名并放到隐蔽路径
adb shell "mkdir -p /data/data/com.android.systemui/.cache"
adb push patched /data/data/com.android.systemui/.cache/runtime_daemon

# 3. 使用随机端口
PORT=$((RANDOM % 10000 + 50000))
adb shell "/data/data/com.android.systemui/.cache/runtime_daemon -l 0.0.0.0:$PORT &"

# 4. 端口转发
adb forward tcp:$PORT tcp:$PORT

# 5. 配合 Magisk Hide
adb shell "magisk --hide com.example.app"
```

### 场景 4: 极端检测的 App

**检测手段**: 源码级检测 + 完整性校验

**方案**: 需要从源码修改
```bash
# 1. 使用 Florida Patch 修改源码
git clone https://github.com/Ylarod/Florida.git
cd frida-core
git am ../Florida/patches/frida-core/*.patch

# 2. 修改关键标识
# 在 frida-core/src/darwin/frida-helper-backend.vala 中
# 修改 g_set_prgname ("ggbond");  # 改成随机名称

# 3. 编译
./configure --host=android-arm64
make

# 4. 再用 v2 工具修补
python anti-anti-frida_v2.py frida-server --aggressive

# 5. 部署（同场景3）
```

## 🔧 高级技巧

### 技巧 1: 使用自定义配置

```bash
# 1. 生成配置文件
python anti-anti-frida_v2.py --create-config

# 2. 编辑配置文件
vim anti-frida-enhanced-config.json
```

```json
{
  "patch_strings": [
    "FridaScriptEngine",
    "YourCustomString",  // 添加自定义特征
    ...
  ],
  "thread_names": [
    ["gum-js-loop", 11],
    ["your-thread", 11]  // 添加自定义线程名
  ],
  "random_seed": 1234  // 固定随机种子，确保可复现
}
```

```bash
# 3. 使用配置文件
python anti-anti-frida_v2.py frida-server -c anti-frida-enhanced-config.json
```

### 技巧 2: 批量处理

```bash
#!/bin/bash
# 批量处理多个架构的 frida-server

for arch in arm arm64 x86 x86_64; do
    echo "Processing frida-server-$arch..."
    python anti-anti-frida_v2.py \
        frida-server-16.0.0-android-$arch \
        -o frida-server-patched-$arch \
        --aggressive \
        --log-file patch-$arch.log
done

echo "All done!"
```

### 技巧 3: 自动化部署脚本

```bash
#!/bin/bash
# deploy_frida.sh - 自动化部署脚本

FRIDA_FILE="frida-server-patched"
RANDOM_PORT=$((RANDOM % 10000 + 50000))
DEVICE_PATH="/data/local/tmp/$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13)"

echo "正在部署 Frida..."
echo "端口: $RANDOM_PORT"
echo "路径: $DEVICE_PATH"

# 推送文件
adb push $FRIDA_FILE $DEVICE_PATH
adb shell "chmod 755 $DEVICE_PATH"

# 启动
adb shell "$DEVICE_PATH -l 0.0.0.0:$RANDOM_PORT &"

# 端口转发
adb forward tcp:$RANDOM_PORT tcp:$RANDOM_PORT

echo "部署完成！"
echo "连接命令: frida-ps -H 127.0.0.1:$RANDOM_PORT"
```

### 技巧 4: 验证脚本

```bash
#!/bin/bash
# verify_frida.sh - 验证 Frida 是否被检测

APP_PACKAGE="com.example.app"

echo "启动应用..."
adb shell "am start -n $APP_PACKAGE/.MainActivity"

sleep 2

echo "检查 Frida 是否被检测..."
adb logcat -d | grep -i "frida\|detect\|debug"

echo "检查应用是否异常退出..."
PID=$(adb shell "pidof $APP_PACKAGE")
if [ -z "$PID" ]; then
    echo "[!] 应用已退出，可能被检测到"
else
    echo "[✓] 应用运行正常 (PID: $PID)"
fi
```

## ⚠️ 常见问题

### Q1: 修补后 frida-server 无法启动

**原因**: 可能破坏了关键函数

**解决**:
```bash
# 1. 使用标准模式而不是激进模式
python anti-anti-frida_v2.py frida-server -o patched

# 2. 检查文件完整性
ls -lh patched
file patched

# 3. 查看启动日志
adb shell "/data/local/tmp/patched" 2>&1 | tee frida.log
```

### Q2: 修补后可以启动但无法连接

**原因**: 网络配置或端口问题

**解决**:
```bash
# 1. 检查 frida-server 是否在运行
adb shell "ps | grep frida"

# 2. 检查端口监听
adb shell "netstat -tlnp | grep 27042"  # 或你的自定义端口

# 3. 尝试明确指定监听地址
adb shell "/data/local/tmp/patched -l 0.0.0.0:27042"
```

### Q3: 修补后仍然被检测

**可能原因**:
1. App 检测端口（27042）
2. App 检测进程名
3. App 检测文件路径
4. App 有其他检测手段（Maps、Hook 检测等）

**解决**:
```bash
# 完整反检测方案
# 1. 使用激进模式修补
python anti-anti-frida_v2.py frida-server --aggressive -o patched

# 2. 修改端口
PORT=58888

# 3. 重命名并放到隐蔽路径
adb push patched /data/local/tmp/.system_service

# 4. 启动
adb shell "/data/local/tmp/.system_service -l 127.0.0.1:$PORT &"

# 5. 配合其他工具
# - 使用 Magisk Hide
# - 使用 hide_frida_linjector
# - Hook 反检测函数
```

### Q4: 如何确认修补是否生效

```bash
# 方法 1: 使用分析工具
python frida_analyzer.py frida-server frida-server-patched

# 方法 2: 手动检查符号
readelf -s frida-server-patched | grep -i frida  # 应该无输出

# 方法 3: 手动检查字符串
strings frida-server-patched | grep -i frida    # 应该无或很少输出
```

## 📚 进阶阅读

1. **反检测优化说明.md** - 详细的技术说明
2. **USAGE.md** - 完整的使用文档
3. **魔改frida.md** - 源码级修改指南

## 🎓 学习路线

```
入门 → 基础 → 进阶 → 高级
 ↓      ↓      ↓      ↓
原版   v1     v2    源码修改
                   +运行时隐藏
```

### 入门（1天）
- 了解 Frida 基本用法
- 使用原版工具修补
- 掌握基本部署

### 基础（3天）
- 理解常见检测手段
- 使用 v1 优化版
- 学会配置文件

### 进阶（1周）
- 深入理解反检测原理
- 使用 v2 深度优化版
- 掌握激进模式
- 配合其他工具

### 高级（2周+）
- 修改 Frida 源码
- 运行时动态对抗
- 脚本层面 Hook
- 针对性定制方案

## 💡 最佳实践

1. ✅ **总是先备份原文件**
2. ✅ **使用 --dry-run 预览修改**
3. ✅ **在测试设备上验证**
4. ✅ **记录使用的端口和路径**
5. ✅ **定期更新 Frida 版本**
6. ❌ **不要在生产环境直接测试**
7. ❌ **不要使用默认端口和路径**
8. ❌ **不要忽略应用日志**

---

**祝你反检测成功！** 🎉

如有问题，请查阅详细文档或提交 Issue。

