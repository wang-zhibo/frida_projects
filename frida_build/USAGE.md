# Anti-Anti-Frida 工具使用指南

## 📖 简介

这是一个增强优化版的 Anti-Anti-Frida 工具，用于修改 Frida Agent 的特征字符串，帮助绕过常见的 Frida 检测机制。

## ✨ 新增功能

相比原版，新增了以下功能：

- ✅ **参数验证和错误处理** - 完善的输入验证和异常处理
- ✅ **自动备份功能** - 修改前自动创建带时间戳的备份
- ✅ **长度匹配** - 随机字符串长度与原字符串完全匹配
- ✅ **安全的二进制替换** - 用纯 Python 实现替代不安全的 `os.system`
- ✅ **配置文件支持** - 通过 JSON 文件自定义要修补的字符串
- ✅ **多级日志** - 支持详细日志和日志文件输出
- ✅ **跨平台兼容** - 不依赖系统命令（如 sed）
- ✅ **进度显示** - 清晰的步骤和统计信息
- ✅ **干运行模式** - 预览修改而不实际执行
- ✅ **命令行参数** - 丰富的命令行选项

## 📦 依赖安装

```bash
pip install lief
```

## 🚀 快速开始

### 1. 基本使用（最简单）

```bash
# 直接修改文件（会自动创建备份）
python "anti-anti-frida copy.py" frida-agent.so
```

### 2. 指定输出文件

```bash
# 保留原文件，输出到新文件
python "anti-anti-frida copy.py" frida-agent.so -o frida-agent-patched.so
```

### 3. 预览模式（推荐新手）

```bash
# 先预览会做哪些修改，不实际执行
python "anti-anti-frida copy.py" frida-agent.so --dry-run
```

### 4. 详细输出

```bash
# 查看详细的调试信息
python "anti-anti-frida copy.py" frida-agent.so -v
```

### 5. 保存日志

```bash
# 将日志保存到文件，便于审查
python "anti-anti-frida copy.py" frida-agent.so --log-file patch.log
```

## 🔧 高级用法

### 使用自定义配置

1. 生成默认配置文件：

```bash
python "anti-anti-frida copy.py" --create-config
```

这会创建 `anti-frida-config.json` 文件。

2. 编辑配置文件，自定义要修补的字符串：

```json
{
  "patch_strings": [
    "FridaScriptEngine",
    "GLib-GIO",
    "YourCustomString"
  ],
  "thread_names": [
    ["gum-js-loop", 11],
    ["gmain", 5]
  ]
}
```

3. 使用自定义配置：

```bash
python "anti-anti-frida copy.py" frida-agent.so -c anti-frida-config.json
```

### 不创建备份（慎用）

```bash
python "anti-anti-frida copy.py" frida-agent.so --no-backup
```

**⚠️ 警告**: 这会直接覆盖原文件且无法恢复！

## 📋 完整参数说明

```
positional arguments:
  input_file            输入的 Frida Agent 文件路径

optional arguments:
  -h, --help            显示帮助信息
  -o OUTPUT, --output OUTPUT
                        输出文件路径（默认覆盖原文件）
  --no-backup           不创建备份文件
  --dry-run             干运行模式：预览修改但不实际执行
  -c CONFIG, --config CONFIG
                        自定义配置文件路径（JSON 格式）
  --create-config       创建默认配置文件并退出
  -v, --verbose         详细输出（调试模式）
  --log-file LOG_FILE   保存日志到文件
  --version             显示版本号
```

## 📊 输出示例

```
============================================================
Anti-Anti-Frida Tool - 优化增强版 v2.0.0
============================================================
[*] 文件大小: 12.45 MB
[✓] 备份已创建: frida-agent.so.bak_20241029_143022.so
[*] 开始修补 Frida Agent: frida-agent.so
[*] 解析 ELF 文件...
============================================================
步骤 1: 修补符号表
============================================================
[*] 将 'frida' 替换为 'xKmPq'
[✓] 符号修补完成: 158 个符号
============================================================
步骤 2: 修补特征字符串
============================================================
[*] 修补字符串: offset=0x12a4f0 FridaScriptEngine -> enignEtpircSadirF
[*] 修补字符串: offset=0x14b820 GLib-GIO -> OIG-biLG
[✓] 字符串修补完成: 12 处修改
============================================================
步骤 3: 修补线程名称
============================================================
[*] 修补线程名: gum-js-loop -> RtYuPlKmNbV
[*] 修补线程名: gmain -> WxZaB
[*] 修补线程名: gdbus -> QwErT
[✓] 线程名修补完成: 3 个线程

============================================================
修补统计
============================================================
符号修补数量:   158
字符串修补数量: 12
线程名修补数量: 3
总修改数量:     173
============================================================

✨ 修补完成！输出文件: frida-agent.so
```

## 🛡️ 安全建议

1. **首次使用建议流程**：
   ```bash
   # 1. 先用干运行模式预览
   python "anti-anti-frida copy.py" frida-agent.so --dry-run -v
   
   # 2. 确认无误后，输出到新文件测试
   python "anti-anti-frida copy.py" frida-agent.so -o test.so
   
   # 3. 测试新文件是否正常工作
   # 测试通过后再用于生产
   ```

2. **保留原始文件** - 始终保留未修改的原始 Frida Agent 文件

3. **检查备份** - 修改前检查备份文件是否创建成功

4. **测试修补后的文件** - 在实际使用前先在测试环境验证

## 🔍 故障排除

### 问题 1: "不是有效的 ELF 文件"

**原因**: 输入文件不是 ELF 格式的二进制文件

**解决**: 确认文件是 Linux/Android 的 `.so` 文件

### 问题 2: "文件不可读"

**原因**: 权限不足

**解决**: 
```bash
chmod +r frida-agent.so
```

### 问题 3: 修补后 Frida 无法正常工作

**原因**: 可能修改了关键字符串导致功能异常

**解决**: 
1. 使用备份文件恢复
2. 调整配置文件，减少修补的字符串数量
3. 逐步测试哪些字符串可以安全修改

## 📝 配置文件说明

### patch_strings

要在 `.rodata` 段中修补的字符串列表。这些字符串会被反转。

**建议**: 
- 只添加确认是检测特征的字符串
- 避免修改功能相关的字符串

### thread_names

要修补的线程名称及其长度。格式：`[线程名, 随机字符串长度]`

**注意**:
- 随机字符串长度必须与原线程名长度一致
- 否则会破坏二进制结构

## 🤝 与原版对比

| 特性 | 原版 | 优化版 |
|-----|-----|-------|
| 参数验证 | ❌ | ✅ |
| 备份功能 | ❌ | ✅ |
| 配置文件 | ❌ | ✅ |
| 干运行模式 | ❌ | ✅ |
| 日志系统 | 简单 | 完善 |
| 错误处理 | 基础 | 健壮 |
| 跨平台 | 部分 | 完全 |
| 统计信息 | ❌ | ✅ |
| 命令行参数 | 无 | 丰富 |

## 📚 技术原理

本工具通过以下方式绕过 Frida 检测：

1. **符号表混淆** - 替换 ELF 符号表中包含 "frida" 的符号名
2. **字符串反转** - 反转 `.rodata` 段中的特征字符串
3. **线程名随机化** - 将 Frida 特征线程名替换为随机字符串

这些修改使得常见的检测方法失效：
- 符号名检测
- 内存字符串扫描
- 线程名枚举

## ⚠️ 免责声明

本工具仅供学习和合法的安全研究使用。使用本工具进行任何非法活动，后果自负。

## 📄 License

本项目采用与原项目相同的许可证。

---

**作者**: 优化增强版  
**版本**: 2.0.0  
**最后更新**: 2024-10-29

